#include <typedefs.h>
#include <mt6373_upmu_hw.h>
#include <pal_log.h>
#include <platform.h>
#include <pmic.h>
#include <regulator/mtk_regulator.h>
#include <timer.h>
#if MTK_DOE_CONFIG_ENV_SUPPORT
#include <dconfig_env.h>
#endif

/*
 * CONFIG OPTION SET
 */
/* Enable this option when pmic initial setting is verified */
#define INIT_SETTING_VERIFIED	1

#define EFUSE_SW_LOAD		1

#define pmic_buck_set_lp(_chip, _name, _user, _en, _mode, _cfg) \
{ \
	pmic_config_interface(PMIC_RG_BUCK_##_name##_##_user##_OP_CFG_ADDR, \
			      (_cfg ? 1 << _user : 0), 1 << _user, 0); \
	pmic_config_interface(PMIC_RG_BUCK_##_name##_##_user##_OP_MODE_ADDR, \
			      (_mode ? 1 << _user : 0), 1 << _user, 0); \
	pmic_config_interface(PMIC_RG_BUCK_##_name##_##_user##_OP_EN_ADDR, \
			      (_en ? 1 << _user : 0), 1 << _user, 0); \
}

#define pmic_ldo_set_lp(_chip, _name, _user, _en, _mode, _cfg) \
{ \
	pmic_config_interface(PMIC_RG_LDO_##_name##_##_user##_OP_CFG_ADDR, \
			      (_cfg ? 1 << _user : 0), 1 << _user, 0); \
	pmic_config_interface(PMIC_RG_LDO_##_name##_##_user##_OP_MODE_ADDR, \
			      (_mode ? 1 << _user : 0), 1 << _user, 0); \
	pmic_config_interface(PMIC_RG_LDO_##_name##_##_user##_OP_EN_ADDR, \
			      (_en ? 1 << _user : 0), 1 << _user, 0); \
}

static void wk_rf_power_setting(void)
{
	pmic_buck_set_lp(MT6363, VBUCK6, RC1, true, OP_MODE_LP, HW_OFF);
	pmic_buck_set_lp(MT6363, VBUCK1, RC1, true, OP_MODE_LP, HW_OFF);
	pmic_ldo_set_lp(MT6363, VSRAM_DIGRF, RC1, true, OP_MODE_LP, HW_OFF);
	pmic_ldo_set_lp(MT6363, VSRAM_MODEM, RC0, true, OP_MODE_LP, HW_LP);
	pmic_config_interface(PMIC_PMRC_EN0_ADDR, 0x0, 0x10, 0); /* clear RC4 */
	pmic_ldo_set_lp(MT6363, VCN15, RC3, true, OP_MODE_MU, HW_OFF);
	udelay(1500); /* RF request delay 1500us */
	pmic_ldo_set_lp(MT6363, VRF09, RC4, true, OP_MODE_MU, HW_OFF);
	pmic_ldo_set_lp(MT6363, VRF12, RC2, true, OP_MODE_LP, HW_OFF);
	pmic_ldo_set_lp(MT6363, VRF13, RC4, true, OP_MODE_MU, HW_OFF);
	pmic_ldo_set_lp(MT6363, VRF18, RC4, true, OP_MODE_MU, HW_OFF);
	pmic_config_interface(PMIC_PMRC_EN0_ADDR, 0x10, 0x10, 0); /* set RC4 */
}

static void wk_vs2_voter_setting(void)
{
	/*
	 * 1. Set VS2_VOTER_VOSEL = 1.37V
	 * 2. Set VS2_VOTER_EN = 0x8 (bit3 for MD RF)
	 */
	pmic_config_interface(PMIC_RG_BUCK_VS2_VOTER_VOSEL_ADDR, 0x6E,
			      PMIC_RG_BUCK_VS2_VOTER_VOSEL_MASK,
			      PMIC_RG_BUCK_VS2_VOTER_VOSEL_SHIFT);
	pmic_config_interface(PMIC_RG_BUCK_VS2_VOTER_EN_LO_ADDR, 0x8,
			      PMIC_RG_BUCK_VS2_VOTER_EN_LO_MASK,
			      PMIC_RG_BUCK_VS2_VOTER_EN_LO_SHIFT);
}

struct pmic_setting {
	unsigned short addr;
	unsigned short val;
	unsigned short mask;
	unsigned char shift;
};

static struct pmic_setting init_setting[] = {
	{0x16, 0xA, 0xA, 0},
	{0x19, 0x1F, 0x1F, 0},
	{0x21, 0x1, 0x1, 0},
	{0x22, 0x1, 0x1, 0},
	{0x47, 0x0, 0xFF, 0},
	{0x4A, 0x0, 0x80, 0},
	{0x53, 0x1, 0x1, 0},
	{0x55, 0x5, 0x5, 0},
	{0x8E, 0x60, 0xFF, 0},
	{0x91, 0xC0, 0xFF, 0},
	{0xAD, 0x0, 0x38, 0},
	{0x10F, 0x10, 0x10, 0},
	{0x112, 0x4, 0x4, 0},
	{0x12D, 0x1, 0x1, 0},
	{0x139, 0x21, 0x21, 0},
	{0x230, 0x0, 0x1, 0},
	{0x251, 0xA8, 0xFF, 0},
	{0x413, 0x7, 0xFF, 0},
	{0x416, 0x12, 0xFF, 0},
	{0x417, 0x0, 0x7, 0},
	{0x90D, 0x10, 0x10, 0},
	{0x98A, 0x10, 0x10, 0},
	{0xA08, 0x1, 0x1, 0},
	{0xA0C, 0x79, 0x7F, 0},
	{0xA0E, 0x0, 0x2, 0},
	{0xA0F, 0x1, 0x1, 0},
	{0xA10, 0xE0, 0xE0, 0},
	{0xA14, 0x40, 0x60, 0},
	{0xA22, 0x80, 0x80, 0},
	{0xA26, 0xFF, 0xFF, 0},
	{0xA27, 0xFF, 0xFF, 0},
	{0xA28, 0xFF, 0xFF, 0},
	{0xA29, 0xFF, 0xFF, 0},
	{0xA2A, 0x1, 0x1, 0},
	{0xA39, 0x2E, 0xFF, 0},
	{0xA3A, 0x1, 0xFF, 0},
	{0xA3B, 0x1, 0xFF, 0},
	{0xA3C, 0x9, 0xFF, 0},
	{0xA3D, 0x5, 0xFF, 0},
	{0xA3E, 0x7, 0xFF, 0},
	{0xA3F, 0x7, 0xFF, 0},
	{0xA40, 0x3, 0xFF, 0},
	{0xA41, 0x21, 0xFF, 0},
	{0xA42, 0x9, 0xFF, 0},
	{0xA43, 0xB, 0xFF, 0},
	{0xA44, 0xD, 0xFF, 0},
	{0xA45, 0xE, 0xFF, 0},
	{0xA46, 0x10, 0xFF, 0},
	{0xA47, 0x13, 0xFF, 0},
	{0xA48, 0x14, 0xFF, 0},
	{0xA49, 0x14, 0xFF, 0},
	{0xA4A, 0x14, 0xFF, 0},
	{0xA4B, 0x19, 0xFF, 0},
	{0xA4C, 0x15, 0xFF, 0},
	{0xA4D, 0x15, 0xFF, 0},
	{0xA4E, 0x16, 0xFF, 0},
	{0xA4F, 0x18, 0xFF, 0},
	{0xA50, 0x2D, 0xFF, 0},
	{0xA51, 0x19, 0xFF, 0},
	{0xA52, 0x19, 0xFF, 0},
	{0xA53, 0x23, 0xFF, 0},
	{0xA54, 0x29, 0xFF, 0},
	{0xA55, 0x29, 0xFF, 0},
	{0xA56, 0x2D, 0xFF, 0},
	{0xC88, 0x10, 0x10, 0},
	{0xC89, 0x18, 0xFE, 0},
	{0xC8A, 0x4, 0xFF, 0},
	{0xC90, 0x44, 0x7F, 0},
	{0xD08, 0x0, 0x1, 0},
	{0xDA1, 0x4, 0x7, 0},
	{0xE88, 0x0, 0x40, 0},
	{0xE89, 0x40, 0x40, 0},
	{0xF8C, 0x15, 0x15, 0},
	{0xF8D, 0x5, 0x5, 0},
	{0x1188, 0x0, 0x80, 0},
	{0x140E, 0x0, 0x40, 0},
	{0x1445, 0x0, 0xFF, 0},
	{0x1446, 0x0, 0xFF, 0},
	{0x1447, 0x0, 0xF, 0},
	{0x1487, 0x6C, 0xFF, 0},
	{0x1488, 0x0, 0x1, 0},
	{0x1507, 0x58, 0xFF, 0},
	{0x1508, 0x0, 0x1, 0},
	{0x1587, 0x58, 0xFF, 0},
	{0x1588, 0x0, 0x1, 0},
	{0x1607, 0x58, 0xFF, 0},
	{0x1608, 0x0, 0x1, 0},
	{0x160A, 0xC, 0x7F, 0},
	{0x1687, 0x78, 0xFF, 0},
	{0x1688, 0x0, 0x1, 0},
	{0x168A, 0xC, 0x7F, 0},
	{0x1707, 0xA8, 0xFF, 0},
	{0x1708, 0x0, 0x1, 0},
	{0x1788, 0x0, 0x1, 0},
	{0x1808, 0x0, 0x1, 0},
	{0x180A, 0x5, 0x7F, 0},
	{0x1887, 0x98, 0xFF, 0},
	{0x1888, 0x0, 0x1, 0},
	{0x1907, 0x68, 0xFF, 0},
	{0x1908, 0x0, 0x1, 0},
	{0x198A, 0x2E, 0x2F, 0},
	{0x198C, 0xF8, 0xF8, 0},
	{0x198D, 0x32, 0x3F, 0},
	{0x198F, 0xC, 0xC, 0},
	{0x1990, 0xEF, 0xFF, 0},
	{0x1991, 0x10, 0xFF, 0},
	{0x1992, 0x0, 0xF, 0},
	{0x1995, 0x60, 0x64, 0},
	{0x1996, 0x45, 0xFF, 0},
	{0x1997, 0x2, 0x2, 0},
	{0x1998, 0x10, 0x10, 0},
	{0x1999, 0x2E, 0x2F, 0},
	{0x199B, 0xF8, 0xF8, 0},
	{0x199C, 0x32, 0x3F, 0},
	{0x199E, 0xC, 0xC, 0},
	{0x199F, 0xEF, 0xFF, 0},
	{0x19A0, 0x0, 0xFF, 0},
	{0x19A4, 0x60, 0x64, 0},
	{0x19A5, 0x45, 0xFF, 0},
	{0x19A6, 0x2, 0x2, 0},
	{0x19AC, 0x80, 0x80, 0},
	{0x19AF, 0x0, 0x1, 0},
	{0x19B4, 0x0, 0x80, 0},
	{0x19B7, 0x1, 0x1, 0},
	{0x1A08, 0x50, 0x50, 0},
	{0x1A09, 0x2D, 0x2F, 0},
	{0x1A0B, 0xF8, 0xF8, 0},
	{0x1A0C, 0x32, 0x3F, 0},
	{0x1A0E, 0xC, 0xC, 0},
	{0x1A0F, 0xEF, 0xFF, 0},
	{0x1A10, 0x10, 0xFF, 0},
	{0x1A12, 0x10, 0x50, 0},
	{0x1A13, 0x2D, 0x2F, 0},
	{0x1A14, 0xC1, 0xC1, 0},
	{0x1A15, 0xFA, 0xFF, 0},
	{0x1A16, 0x32, 0x3F, 0},
	{0x1A18, 0xC, 0xC, 0},
	{0x1A19, 0x77, 0xFF, 0},
	{0x1A1A, 0xC0, 0xFF, 0},
	{0x1A1B, 0x2B, 0x7F, 0},
	{0x1A1C, 0x10, 0x50, 0},
	{0x1A1D, 0x2D, 0x2F, 0},
	{0x1A1E, 0x1, 0x1, 0},
	{0x1A1F, 0xFA, 0xFF, 0},
	{0x1A20, 0x32, 0x3F, 0},
	{0x1A22, 0xC, 0xC, 0},
	{0x1A23, 0x77, 0xFF, 0},
	{0x1A24, 0xC0, 0xFF, 0},
	{0x1A25, 0x2B, 0x7F, 0},
	{0x1A27, 0x2E, 0x2F, 0},
	{0x1A29, 0xF8, 0xF8, 0},
	{0x1A2A, 0x32, 0x3F, 0},
	{0x1A2C, 0xC, 0xC, 0},
	{0x1A2D, 0xEF, 0xFF, 0},
	{0x1A2E, 0x10, 0xFF, 0},
	{0x1A2F, 0x0, 0xF, 0},
	{0x1A35, 0x0, 0xF0, 0},
	{0x1A37, 0xFE, 0xFF, 0},
	{0x1A39, 0xCD, 0xFF, 0},
	{0x1A3A, 0x5F, 0xFF, 0},
	{0x1A3B, 0x5F, 0xFF, 0},
	{0x1A3C, 0x45, 0xFF, 0},
	{0x1A3D, 0xF0, 0xF0, 0},
	{0x1A45, 0x0, 0x80, 0},
	{0x1A4C, 0x7, 0x87, 0},
	{0x1A53, 0x7, 0x87, 0},
	{0x1A5A, 0x0, 0x80, 0},
	{0x1A5D, 0x8, 0x78, 0},
	{0x1A88, 0x50, 0x50, 0},
	{0x1A89, 0x2D, 0x2F, 0},
	{0x1A8B, 0xF8, 0xF8, 0},
	{0x1A8C, 0x32, 0x3F, 0},
	{0x1A8E, 0xC, 0xC, 0},
	{0x1A8F, 0xEF, 0xFF, 0},
	{0x1A90, 0x0, 0xFF, 0},
	{0x1A92, 0x10, 0x56, 0},
	{0x1A93, 0x2D, 0x2F, 0},
	{0x1A94, 0x0, 0x1, 0},
	{0x1A95, 0xFC, 0xFF, 0},
	{0x1A96, 0x32, 0x3F, 0},
	{0x1A98, 0xC, 0xC, 0},
	{0x1A99, 0xEF, 0xFF, 0},
	{0x1A9A, 0x10, 0xFF, 0},
	{0x1A9B, 0x4, 0xF, 0},
	{0x1A9C, 0x10, 0x50, 0},
	{0x1A9D, 0x2D, 0x2F, 0},
	{0x1A9E, 0xC1, 0xC1, 0},
	{0x1A9F, 0xFA, 0xFF, 0},
	{0x1AA0, 0x32, 0x3F, 0},
	{0x1AA2, 0xC, 0xC, 0},
	{0x1AA3, 0x77, 0xFF, 0},
	{0x1AA4, 0xC0, 0xFF, 0},
	{0x1AA5, 0x2B, 0x7F, 0},
	{0x1AA6, 0x10, 0x50, 0},
	{0x1AA7, 0x2D, 0x2F, 0},
	{0x1AA8, 0x1, 0x1, 0},
	{0x1AA9, 0xFA, 0xFF, 0},
	{0x1AAA, 0x32, 0x3F, 0},
	{0x1AAC, 0xC, 0xC, 0},
	{0x1AAD, 0x77, 0xFF, 0},
	{0x1AAE, 0xC0, 0xFF, 0},
	{0x1AAF, 0x2B, 0x7F, 0},
	{0x1AB5, 0x0, 0xF0, 0},
	{0x1AB7, 0xFC, 0xFE, 0},
	{0x1AB9, 0xCD, 0xFF, 0},
	{0x1ABA, 0xE5, 0xFF, 0},
	{0x1ABB, 0x5F, 0xFF, 0},
	{0x1ABC, 0x5F, 0xFF, 0},
	{0x1ABD, 0xF0, 0xF0, 0},
	{0x1ABE, 0x20, 0x20, 0},
	{0x1AC5, 0x80, 0x80, 0},
	{0x1ACC, 0x0, 0x80, 0},
	{0x1AD3, 0x0, 0x80, 0},
	{0x1ADA, 0x0, 0x80, 0},
	{0x1ADD, 0x0, 0x78, 0},
	{0x1B0D, 0xF, 0xF, 0},
	{0x1B0E, 0x1, 0x1, 0},
	{0x1B11, 0xFF, 0xFF, 0},
	{0x1B14, 0xFF, 0xFF, 0},
	{0x1B17, 0xFF, 0xFF, 0},
	{0x1B1A, 0x1, 0x1, 0},
	{0x1B33, 0x8, 0x8, 0},
	{0x1B39, 0x0, 0x1, 0},
	{0x1B88, 0x10, 0x10, 0},
	{0x1B89, 0x0, 0x80, 0},
	{0x1B96, 0x10, 0x10, 0},
	{0x1B97, 0x0, 0x80, 0},
	{0x1BA4, 0x10, 0x10, 0},
	{0x1BA5, 0x0, 0x80, 0},
	{0x1BB2, 0x10, 0x10, 0},
	{0x1BB3, 0x0, 0x80, 0},
	{0x1BC0, 0x10, 0x10, 0},
	{0x1BC1, 0x0, 0x80, 0},
	{0x1BCE, 0x10, 0x10, 0},
	{0x1BCF, 0x0, 0x80, 0},
	{0x1C08, 0x10, 0x10, 0},
	{0x1C09, 0x0, 0x80, 0},
	{0x1C0E, 0x40, 0x40, 0},
	{0x1C16, 0x10, 0x10, 0},
	{0x1C17, 0x0, 0x80, 0},
	{0x1C1C, 0x40, 0x40, 0},
	{0x1C24, 0x10, 0x10, 0},
	{0x1C25, 0x0, 0x80, 0},
	{0x1C32, 0x10, 0x10, 0},
	{0x1C33, 0x0, 0x80, 0},
	{0x1C40, 0x10, 0x10, 0},
	{0x1C41, 0x0, 0x80, 0},
	{0x1C4E, 0x10, 0x10, 0},
	{0x1C4F, 0x0, 0x80, 0},
	{0x1C88, 0x10, 0x10, 0},
	{0x1C89, 0x0, 0x80, 0},
	{0x1C96, 0x10, 0x10, 0},
	{0x1C97, 0x0, 0x80, 0},
	{0x1CA4, 0x10, 0x10, 0},
	{0x1CA5, 0x0, 0x80, 0},
	{0x1CB2, 0x10, 0x10, 0},
	{0x1CB3, 0x0, 0x80, 0},
	{0x1CC0, 0x10, 0x10, 0},
	{0x1CC1, 0x0, 0x80, 0},
	{0x1D08, 0x10, 0x10, 0},
	{0x1D09, 0x0, 0x80, 0},
	{0x1D1E, 0x10, 0x10, 0},
	{0x1D1F, 0x0, 0x80, 0},
	{0x1D88, 0x10, 0x10, 0},
	{0x1D89, 0x0, 0x80, 0},
	{0x1DA3, 0x10, 0x10, 0},
	{0x1DA4, 0x0, 0x80, 0},
	{0x1DA8, 0x18, 0x7F, 0},
	{0x1DB8, 0x14, 0x1C, 0},
	{0x1DB9, 0xF, 0xF, 0},
	{0x1DBA, 0xC0, 0xFF, 0},
	{0x1DBC, 0x60, 0xFF, 0},
	{0x1E08, 0x10, 0x10, 0},
	{0x1E09, 0x0, 0x80, 0},
	{0x1E1E, 0x10, 0x10, 0},
	{0x1E1F, 0x0, 0x80, 0},
	{0x1E88, 0x10, 0x10, 0},
	{0x1E89, 0x0, 0x80, 0},
	{0x1E9E, 0x10, 0x10, 0},
	{0x1E9F, 0x0, 0x80, 0},
	{0x1F16, 0x2, 0x3, 0},
	{0x1F1B, 0x2, 0xF, 0},
	{0x1F1E, 0x2, 0x3, 0},
	{0x1F2A, 0x2, 0x3, 0},
	{0x1F2E, 0x2, 0x3, 0},
	{0x1F8A, 0x8, 0xC, 0},
	{0x1F8C, 0x4, 0x6, 0},
	{0x1F8E, 0x4, 0x6, 0},
	{0x1F90, 0x4, 0x6, 0},
	{0x1F94, 0x2, 0x3, 0},
	{0x1F98, 0x1, 0x3, 0},
	{0x1F9C, 0x1, 0x3, 0},
	{0x1FA0, 0x2, 0x3, 0},
	{0x1FA4, 0x8, 0xC, 0},
	{0x1FAB, 0x8, 0xC, 0},
	{0x1FAD, 0x4, 0x6, 0},
	{0x1FB0, 0x0, 0x10, 0},
	{0x2207, 0xE0, 0xE0, 0},
	{0x2208, 0xE0, 0xE0, 0},
	{0x2209, 0xE0, 0xE0, 0},
	{0x220A, 0xE0, 0xE0, 0},
	{0x2214, 0xF0, 0xF0, 0},
};

#if MTK_DOE_CONFIG_ENV_SUPPORT
#define DOE_UPDATE(_item)	\
{	\
	doe_##_item = dconfig_getenv(#_item);	\
	if (doe_##_item)	\
		_item = atoi(doe_##_item);\
	pal_log_info(#_item " %d\n", _item);\
}

static void doe_load(void)
{
	static int vcpub_rrate, vcpub_frate;
	static int vcpum_rrate, vcpum_frate;
	static int vcpul_rrate, vcpul_frate;
	char *doe_vcpub_rrate, *doe_vcpub_frate;
	char *doe_vcpum_rrate, *doe_vcpum_frate;
	char *doe_vcpul_rrate, *doe_vcpul_frate;

	DOE_UPDATE(vcpub_rrate);
	DOE_UPDATE(vcpub_frate);
	DOE_UPDATE(vcpum_rrate);
	DOE_UPDATE(vcpum_frate);
	DOE_UPDATE(vcpul_rrate);
	DOE_UPDATE(vcpul_frate);
	if (vcpub_rrate || vcpub_frate)
		mt6319_set_buck_slew_rate(6, 1, vcpub_rrate, vcpub_frate);
	if (vcpub_rrate) {
		pmic_config_interface(PMIC_RG_LDO_VSRAM_CPUB_SFCHG_RRATE_ADDR,
				      162500 / vcpub_rrate / 1000 - 1,
				      PMIC_RG_LDO_VSRAM_CPUB_SFCHG_RRATE_MASK,
				      PMIC_RG_LDO_VSRAM_CPUB_SFCHG_RRATE_SHIFT);
	}
	if (vcpub_frate) {
		pmic_config_interface(PMIC_RG_LDO_VSRAM_CPUB_SFCHG_FRATE_ADDR,
				      162500 / vcpub_frate / 1000 - 1,
				      PMIC_RG_LDO_VSRAM_CPUB_SFCHG_FRATE_MASK,
				      PMIC_RG_LDO_VSRAM_CPUB_SFCHG_FRATE_SHIFT);
	}
	if (vcpum_rrate || vcpum_frate)
		mt6319_set_buck_slew_rate(7, 1, vcpum_rrate, vcpum_frate);
	if (vcpum_rrate) {
		pmic_config_interface(PMIC_RG_LDO_VSRAM_CPUM_SFCHG_RRATE_ADDR,
				      162500 / vcpum_rrate / 1000 - 1,
				      PMIC_RG_LDO_VSRAM_CPUM_SFCHG_RRATE_MASK,
				      PMIC_RG_LDO_VSRAM_CPUM_SFCHG_RRATE_SHIFT);
	}
	if (vcpum_frate) {
		pmic_config_interface(PMIC_RG_LDO_VSRAM_CPUM_SFCHG_FRATE_ADDR,
				      162500 / vcpum_frate / 1000 - 1,
				      PMIC_RG_LDO_VSRAM_CPUM_SFCHG_FRATE_MASK,
				      PMIC_RG_LDO_VSRAM_CPUM_SFCHG_FRATE_SHIFT);
	}
	if (vcpul_rrate) {
		second_pmic_config_interface(MT6373_PMIC_RG_BUCK_VBUCK9_SFCHG_RRATE_ADDR,
					     162500 / vcpul_rrate / 1000 - 1,
					     MT6373_PMIC_RG_BUCK_VBUCK9_SFCHG_RRATE_MASK,
					     MT6373_PMIC_RG_BUCK_VBUCK9_SFCHG_RRATE_SHIFT);
		pmic_config_interface(PMIC_RG_LDO_VSRAM_CPUL_SFCHG_RRATE_ADDR,
				      162500 / vcpul_rrate / 1000 - 1,
				      PMIC_RG_LDO_VSRAM_CPUL_SFCHG_RRATE_MASK,
				      PMIC_RG_LDO_VSRAM_CPUL_SFCHG_RRATE_SHIFT);
	}
	if (vcpul_frate) {
		second_pmic_config_interface(MT6373_PMIC_RG_BUCK_VBUCK9_SFCHG_FRATE_ADDR,
					     162500 / vcpul_frate / 1000 - 1,
					     MT6373_PMIC_RG_BUCK_VBUCK9_SFCHG_FRATE_MASK,
					     MT6373_PMIC_RG_BUCK_VBUCK9_SFCHG_FRATE_SHIFT);
		pmic_config_interface(PMIC_RG_LDO_VSRAM_CPUL_SFCHG_FRATE_ADDR,
				      162500 / vcpul_frate / 1000 - 1,
				      PMIC_RG_LDO_VSRAM_CPUL_SFCHG_FRATE_MASK,
				      PMIC_RG_LDO_VSRAM_CPUL_SFCHG_FRATE_SHIFT);
	}
}
#endif

#define DEFINE_REGULATOR(_name) \
	struct mtk_regulator reg_##_name = empty_regulator

#define REGULATOR_INIT(_name) \
	if (mtk_regulator_get(#_name, &reg_##_name)) \
		ret |= (1 << _error_id); \
	_error_id++; \

#define SET_VOLTAGE(_name, _vol) \
	if (mtk_regulator_set_voltage(&reg_##_name, _vol, _vol)) \
		ret |= (1 << _error_id); \
	_error_id++; \

#define GET_VOLTAGE(_name) \
	pal_log_info(#_name" = %d uV\n", \
		     mtk_regulator_get_voltage(&reg_##_name)); \

static const struct mtk_regulator empty_regulator;
static void pmic_default_voltage(void)
{
	int ret = 0;
	int _error_id = 0;
	DEFINE_REGULATOR(vsram_core);
	DEFINE_REGULATOR(vsram_cpub);
	DEFINE_REGULATOR(vsram_cpum);
	DEFINE_REGULATOR(vsram_cpul);
	DEFINE_REGULATOR(vsram_modem);
	DEFINE_REGULATOR(vsram_digrf);
	DEFINE_REGULATOR(vcore);
	DEFINE_REGULATOR(vcpub);
	DEFINE_REGULATOR(vcpum);
	DEFINE_REGULATOR(vcpul);
	DEFINE_REGULATOR(vgpustack);
	DEFINE_REGULATOR(vapu);
	DEFINE_REGULATOR(vmodem);
	DEFINE_REGULATOR(vdigrf);
	DEFINE_REGULATOR(vcn15); /* for VRFIO18 */

	/*--Get regulator handle--*/
	REGULATOR_INIT(vsram_core);
	REGULATOR_INIT(vsram_cpub);
	REGULATOR_INIT(vsram_cpum);
	REGULATOR_INIT(vsram_cpul);
	REGULATOR_INIT(vsram_modem);
	REGULATOR_INIT(vsram_digrf);
	REGULATOR_INIT(vcore);
	REGULATOR_INIT(vcpub);
	REGULATOR_INIT(vcpum);
	REGULATOR_INIT(vcpul);
	REGULATOR_INIT(vgpustack);
	REGULATOR_INIT(vapu);
	REGULATOR_INIT(vmodem);
	REGULATOR_INIT(vdigrf);
	REGULATOR_INIT(vcn15);
	if (ret) {
		pal_log_err("mtk_regulator_get failed.(0x%x)\n", ret);
		ret = 0;
	}

	/*--Set voltage--*/
	_error_id = 0;
	SET_VOLTAGE(vgpustack, 650000);
	SET_VOLTAGE(vcn15, 1820000);
	if (ret) {
		pal_log_err("mtk_regulator_set_voltage failed.(0x%x)\n", ret);
		ret = 0;
	}

	wk_rf_power_setting();

	/*--Get voltage--*/
	GET_VOLTAGE(vsram_core);
	GET_VOLTAGE(vsram_cpub);
	GET_VOLTAGE(vsram_cpum);
	GET_VOLTAGE(vsram_cpul);
	GET_VOLTAGE(vsram_modem);
	GET_VOLTAGE(vsram_digrf);
	GET_VOLTAGE(vcore);
	GET_VOLTAGE(vcpub);
	GET_VOLTAGE(vcpum);
	GET_VOLTAGE(vcpul);
	GET_VOLTAGE(vgpustack);
	GET_VOLTAGE(vapu);
	GET_VOLTAGE(vmodem);
	GET_VOLTAGE(vdigrf);
	GET_VOLTAGE(vcn15);
}

void pmic_init_setting(void)
{
	U16 i;

#if INIT_SETTING_VERIFIED
	/* TOP_TMA_KEY */
	upmu_set_reg_value16(PMIC_TMA_KEY_L_ADDR, 0x9C9C);
	/* HK_TOP_WKEY */
	upmu_set_reg_value16(PMIC_HK_AUXADC_KEY_L_ADDR, 0x6363);
	/* BUCK_TOP_KEY_PROT */
	upmu_set_reg_value16(PMIC_BUCK_TOP_WRITE_KEY_LO_ADDR, 0x5543);
	/* PLT_KEY */
	upmu_set_reg_value16(PMIC_PLT_WPK_KEY_ADDR, 0x9C9C);
	/* CPS_WKEY */
	upmu_set_reg_value16(PMIC_RG_CPS_W_KEY_ADDR, 0x4729);
	/* BM_BATON_KEY */
	upmu_set_reg_value16(PMIC_BM_BATON_KEY_L_ADDR, 0x1706);

	/* For VIO18 switch to DIG18 feature */
	pmic_config_interface(PMIC_RG_VDIG18_VREF_SEL_ADDR, 0x1,
			      PMIC_RG_VDIG18_VREF_SEL_MASK,
			      PMIC_RG_VDIG18_VREF_SEL_SHIFT);
	for (i = 0; i < ARRAY_SIZE(init_setting); i++) {
		pmic_config_interface(
			init_setting[i].addr, init_setting[i].val,
			init_setting[i].mask, init_setting[i].shift);
	}
#if EFUSE_SW_LOAD
	/* PMIC SW load EFUSE to target register */
	pmic_efuse_sw_load();
#else
	pal_log_info("No EFUSE SW Load\n");
#endif

	/* TOP_TMA_KEY */
	upmu_set_reg_value16(PMIC_TMA_KEY_L_ADDR, 0);
	/* HK_TOP_WKEY */
	upmu_set_reg_value16(PMIC_HK_AUXADC_KEY_L_ADDR, 0);
	/* BUCK_TOP_KEY_PROT */
	upmu_set_reg_value16(PMIC_BUCK_TOP_WRITE_KEY_LO_ADDR, 0);
	/* PLT_KEY */
	upmu_set_reg_value16(PMIC_PLT_WPK_KEY_ADDR, 0);
	/* CPS_WKEY */
	upmu_set_reg_value16(PMIC_RG_CPS_W_KEY_ADDR, 0);
	/* BM_BATON_KEY */
	upmu_set_reg_value16(PMIC_BM_BATON_KEY_L_ADDR, 0);

	pal_log_info("[PMIC] pmic_init_setting end. v211113\n");
#endif
	pmic_config_interface(PMIC_RG_WDT_VOSEL_DBG_EN_ADDR, 1,
			      PMIC_RG_WDT_VOSEL_DBG_EN_MASK,
			      PMIC_RG_WDT_VOSEL_DBG_EN_SHIFT);

#if MTK_DOE_CONFIG_ENV_SUPPORT
	doe_load();
#endif
	pmic_default_voltage();

	wk_vs2_voter_setting();
}
